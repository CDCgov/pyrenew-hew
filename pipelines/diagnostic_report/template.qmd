---
title: "PyRenew-HEW Model Diagnostics"
format:
  dashboard:
    theme:
    - flatly
    - custom.scss
    embed-resources: false
    scrolling: true
params:
  model_dir_raw: "/home/xum8/pyrenew-hew/private_data/pyrenew-test-output/covid-19_r_2024-11-22_f_2024-08-19_t_2024-11-16/model_runs/SC" # pragma: allowlist-secret
---
<!-- Would like mebed-resources to be true, but the current version is problematic with blobfuse -->

```{r Parse Params}
library(reticulate)
library(tidyverse)
library(fs)
library(hewr)
library(knitr)

model_dir <- path(params$model_dir_raw)
model_info <- parse_model_run_dir_path(model_dir)

available_states <- model_dir %>%
  path_dir() %>%
  dir_ls(type = "directory") %>%
  path_file()
```

## {.sidebar}

```{r Render Sidebar}
#| output: asis
library(htmltools)
formatted_available_states <-
  available_states %>%
  map(\(x) a(x, href = path(x, ext = "html"))) %>%
  map(p) %>%
  map_chr(as.character) %>%
  str_c(collapse = "")

cat(formatted_available_states)
```

# Run Info


```{r Model Metadata}
model_info |>
  enframe() |>
  mutate(value = map_chr(value, as.character)) |>
  kable()
```

# Forecasts

```{r Example Forecast}
#| title: A Forecast
library(cowplot)
library(arrow)

theme_set(cowplot::theme_cowplot())
forecast_ci <- read_parquet(
  path(model_dir, "forecast_ci", ext = "parquet")
)
combined_dat <- read_parquet(
  path(model_dir, "combined_training_eval_data", ext = "parquet")
)

figure_save_tbl <-
  expand_grid(
    target_disease = unique(combined_dat$disease),
    y_transform = c("identity", "log10")
  ) |>
  mutate(figure = map2(
    target_disease, y_transform,
    \(target_disease, y_transform) {
      make_forecast_figure(
        target_disease = target_disease,
        combined_dat = combined_dat,
        forecast_ci = forecast_ci,
        disease_name = model_info$disease,
        data_vintage_date = model_info$report_date,
        y_transform = y_transform
      )
    }
  ))
```

## Row {.tabset}

```{r Prop Natural Scale}
#| title: Natural Scale
figure_save_tbl |>
  filter(
    target_disease == "prop_disease_ed_visits",
    y_transform == "identity"
  ) |>
  pull(figure) |>
  pluck(1)
```

```{r Prop Log Scale}
#| title: Log Scale
figure_save_tbl |>
  filter(
    target_disease == "prop_disease_ed_visits",
    y_transform == "log10"
  ) |>
  pull(figure) |>
  pluck(1)
```

## Row {.tabset}

```{r Disease Natural Scale}
#| title: Natural Scale
figure_save_tbl |>
  filter(
    target_disease == "Disease",
    y_transform == "identity"
  ) |>
  pull(figure) |>
  pluck(1)
```

```{r Disease Log Scale}
#| title: Log Scale
figure_save_tbl |>
  filter(
    target_disease == "Disease",
    y_transform == "log10"
  ) |>
  pull(figure) |>
  pluck(1)
```

## Row {.tabset}

```{r Other Natural Scale}
#| title: Natural Scale
figure_save_tbl |>
  filter(
    target_disease == "Other",
    y_transform == "identity"
  ) |>
  pull(figure) |>
  pluck(1)
```

```{r Other Log Scale}
#| title: Log Scale
figure_save_tbl |>
  filter(
    target_disease == "Other",
    y_transform == "log10"
  ) |>
  pull(figure) |>
  pluck(1)
```


# MCMC Diagnostics

```{python Load InferenceData}
from pathlib import Path
import polars as pl
from itables import to_html_datatable
import arviz as az

model_dir = Path(r.params["model_dir_raw"])
idata = az.from_netcdf(Path(model_dir, "inference_data.nc"))
idata_summary = az.summary(idata)
```

```{r Render InferenceData}
#| title: MCMC Summary
library(DT)
datatable(py$idata_summary)
# highlight or exclusively show bad rhats and ess?
```
