name: Submit model pipeline jobs to Azure Batch

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 13 * * 3" # Every Wednesday at 1300 UTC (8 AM ET)
  push:
    branches:
      - startswith(github.ref_name, 'jk') # For testing purposes

env:
  REGISTRY: cfaprdbatchcr.azurecr.io/
  IMAGE_NAME: pyrenew-hew

jobs:

  submit_job_py:

    name: Submit job to azure Batch
    runs-on: ubuntu-latest
    # TODO: change test environment startswith pattern
    environment: |-
      ${{
           github.ref_name == 'main'               && 'production'
        || startsWith(github.ref_name, 'jk')       && 'test'

      }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repo
        id: checkout_repo
        uses: actions/checkout@v4

      # From: https://stackoverflow.com/a/58035262/2097171
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: get-branch

      # From: https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-cloud-providers#requesting-the-jwt-using-the-actions-core-toolkit
      - name: Install OIDC Client from Core Package
        run: npm install @actions/core@1.6.0 @actions/http-client

      - name: Get Id Token
        uses: actions/github-script@v7
        id: idtoken
        with:
          script: |
            const coredemo = require('@actions/core')
            const id_token = await coredemo.getIDToken('api://AzureADTokenExchange')
            coredemo.setOutput('id_token', id_token)


      - name: Submit Pyrenew Hew Job
        id: create_batch_pool
        # Removed invalid condition referencing steps.check_pool_id.outputs.pool-exists
        uses: CDCgov/cfa-actions/runner-action@v1.4.0
        with:
          github_app_id: ${{ secrets.CDCENT_ACTOR_APP_ID }}
          github_app_pem: ${{ secrets.CDCENT_ACTOR_APP_PEM }}
          wait_for_completion: true
          print_logs: true
          script: |
            echo "Logging into Azure CLI"
              az login --service-principal \
              --username ${{ secrets.AZURE_STFT_SP_CLIENT_ID }} \
              --tenant ${{ secrets.AZURE_TENANT_ID }} \
              --federated-token ${{ steps.idtoken.outputs.id_token }} \
              --output none

            echo "Setting env vars for Azure Batch and azuretools compatibility."
              az storage blob download \
              --account-name "cfaazurebatchprd" \
              --container-name "pyrenew-hew-config" \
              --name "azureconfig.sh" \
              --file "./azureconfig.sh" \
              --auth-mode login \
              --overwrite

            # Sourcing the azure config
            source ./azureconfig.sh

            make run_timeseries DRY_RUN=True
