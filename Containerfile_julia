#syntax=docker/dockerfile:1-labs

FROM rocker/tidyverse

ARG GIT_COMMIT_SHA
ENV GIT_COMMIT_SHA=$GIT_COMMIT_SHA

ARG GIT_BRANCH_NAME
ENV GIT_BRANCH_NAME=$GIT_BRANCH_NAME

ENV XLA_FLAGS=--xla_force_host_platform_device_count=4

COPY ./hewr /pyrenew-hew/hewr

WORKDIR /pyrenew-hew

RUN Rscript -e "install.packages('pak')"
RUN Rscript -e "pak::pkg_install('cmu-delphi/epiprocess@main')"
RUN Rscript -e "pak::pkg_install('cmu-delphi/epipredict@main')"
RUN Rscript -e "pak::local_install('hewr', upgrade = FALSE)"

COPY --exclude=pipelines/priors . .
COPY pipelines/priors pipelines/priors

# Python from https://docs.astral.sh/uv/guides/integration/docker/
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/
# Some handy uv environment variables
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy
ENV UV_PYTHON_CACHE_DIR=/root/.cache/uv/python

RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync

# Add Julia with platform detection
RUN apt-get update && apt-get install -y wget ca-certificates && \
    ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then \
        JULIA_ARCH="x64"; \
        JULIA_FILE="julia-1.11.6-linux-x86_64.tar.gz"; \
    elif [ "$ARCH" = "arm64" ]; then \
        JULIA_ARCH="aarch64"; \
        JULIA_FILE="julia-1.11.6-linux-aarch64.tar.gz"; \
    else \
        echo "Unsupported architecture: $ARCH" && exit 1; \
    fi && \
    wget https://julialang-s3.julialang.org/bin/linux/${JULIA_ARCH}/1.11/${JULIA_FILE} && \
    tar -xzf ${JULIA_FILE} -C /opt && \
    ln -s /opt/julia-1.11.6/bin/julia /usr/local/bin/julia && \
    rm ${JULIA_FILE}

# Instantiate Julia deps (EpiAutoGP already copied above)
RUN julia --project=EpiAutoGP -e 'using Pkg; Pkg.instantiate()'
