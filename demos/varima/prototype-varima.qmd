---
title: "Prototype VARIMA"
format: html
---

```{r}
library(pak)
pak::local_install("hewr", ask = FALSE)
pak::pkg_install("epidatr", ask = FALSE)
library(fable)
library(tsibble)
library(epidatr)
library(dplyr)
library(lubridate)
library(forecasttools)
library(tidyr)
# install.packages("MTS")
library(MTS)
```

## Load data


```{r}
signals <- c("pct_ed_visits_covid","pct_ed_visits_influenza", "pct_ed_visits_rsv")

latest_us_nhsn <- pull_nhsn(
            columns = "totalconfflunewadm",
        ) 

latest_us_nssp <- pub_covidcast(
  source = "nssp",
  signals = signals,
  geo_type = "nation",
  time_type = "week",
  as_of = NULL,
)
```   

```{r}   
nssp <- latest_us_nssp |>
        select(geo_value, signal, time_value, issue, value)     
nhsn <- latest_us_nhsn |>
        mutate(time_value = lubridate::as_date(weekendingdate) + 1)|>
        rename(hospital_admissions = totalconfflunewadm) |>
        mutate(hospital_admissions = as.numeric(hospital_admissions)) |>
        group_by(time_value) |>
        summarise(value = sum(hospital_admissions, na.rm = TRUE)) |>
        mutate(geo_value = "us", signal = "nhsn", issue = max(time_value)) |>
        filter(time_value %in% nssp$time_value)

us_data <- bind_rows(nssp,nhsn) |>
  pivot_wider(names_from = signal, values_from = value) |>
  as_tsibble(index = time_value)

```


```{r}
us_data |>
  model(
    ets = ETS(log(nhsn)),
    arima = ARIMA(log(nhsn)),
  ) |>
  forecast(h = "8 weeks") |>
  autoplot(filter(us_data, year(time_value) > 2010), level = NULL)
```


```{r}
us_data |>
  model(
    varima = VARIMA(vars(nhsn, pct_ed_visits_covid, pct_ed_visits_influenza) ~ pdq(1:5,1,1:5)),
  ) |>
  forecast(h = "8 weeks") |>
  autoplot(filter(us_data, year(time_value) > 2010), level = NULL)
```